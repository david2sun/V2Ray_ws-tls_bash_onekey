#!/bin/bash
# è‡ªåŠ¨å®‰è£… Sing-box å¹¶åº”ç”¨è‡ªå®šä¹‰é…ç½®

set -e -o pipefail  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# æ£€æŸ¥æ˜¯å¦ä»¥ root èº«ä»½è¿è¡Œ
if [[ $EUID -ne 0 ]]; then
    echo "è¯·ä»¥ root ç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬ï¼"
    exit 1
fi

echo "ðŸ“Œ æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…å¿…è¦å·¥å…·..."
apt update
apt install -y curl unzip wget

# æ£€æµ‹ CPU æž¶æž„
ARCH_RAW=$(uname -m)
case "${ARCH_RAW}" in
    'x86_64')    ARCH='amd64';;
    'x86' | 'i686' | 'i386')     ARCH='386';;
    'aarch64' | 'arm64') ARCH='arm64';;
    'armv7l')   ARCH='armv7';;
    's390x')    ARCH='s390x';;
    *)          echo "âŒ ä¸æ”¯æŒçš„ CPU æž¶æž„: ${ARCH_RAW}"; exit 1;;
esac
echo "ðŸ“Œ æ£€æµ‹åˆ° CPU æž¶æž„: ${ARCH}"

# èŽ·å– Sing-box æœ€æ–°ç‰ˆæœ¬å·
VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest \
    | grep tag_name \
    | cut -d ":" -f2 \
    | sed 's/\"//g;s/\,//g;s/\ //g;s/v//')

if [[ -z "$VERSION" ]]; then
    echo "âŒ èŽ·å– Sing-box æœ€æ–°ç‰ˆæœ¬å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥ï¼"
    exit 1
fi

echo "ðŸ“Œ æœ€æ–° Sing-box ç‰ˆæœ¬: v$VERSION"

# ä¸‹è½½ Sing-box å®˜æ–¹ deb å®‰è£…åŒ…
echo "ðŸ“Œ æ­£åœ¨ä¸‹è½½ Sing-box deb å®‰è£…åŒ…..."
curl -Lo sing-box.deb "https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box_${VERSION}_linux_${ARCH}.deb"

# ç¡®ä¿ä¸‹è½½æˆåŠŸ
if [[ ! -f "sing-box.deb" ]] || [[ $(stat -c%s "sing-box.deb") -lt 5000000 ]]; then
    echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä»£ç†è®¾ç½®ï¼"
    rm -f sing-box.deb
    exit 1
fi

# å®‰è£… Sing-box
echo "ðŸ“Œ æ­£åœ¨å®‰è£… Sing-box..."
dpkg -i sing-box.deb
rm -f sing-box.deb

# æ£€æŸ¥ Sing-box æ˜¯å¦æ­£ç¡®å®‰è£…
if [[ ! -x /usr/local/bin/sing-box ]]; then
    echo "âŒ Sing-box å®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ dpkg å®‰è£…æ—¥å¿—ï¼"
    exit 1
fi

# è®¾ç½®é…ç½®ç›®å½•å’Œ systemd æœåŠ¡è·¯å¾„
SING_BOX_CONFIG="/etc/sing-box"
SING_BOX_SERVICE="/etc/systemd/system/sing-box.service"

echo "ðŸ“Œ å¼€å§‹åº”ç”¨è‡ªå®šä¹‰é…ç½®..."

# å¤‡ä»½åŽŸæœ‰é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
if [ -f "$SING_BOX_CONFIG/config.json" ]; then
    cp "$SING_BOX_CONFIG/config.json" "$SING_BOX_CONFIG/config.json.bak"
    echo "âœ… å¤‡ä»½åŽŸæœ‰é…ç½®æ–‡ä»¶è‡³ config.json.bak"
fi

# å†™å…¥è‡ªå®šä¹‰é…ç½®
mkdir -p "$SING_BOX_CONFIG"
cat > "$SING_BOX_CONFIG/config.json" <<EOF
{
    "log": {
        "level": "warn"
    },
    "inbounds": [
        {
            "type": "vmess",
            "listen": "::",
            "listen_port": 1080,
            "users": [
                {
                    "uuid": "your-uuid-here"
                }
            ]
        }
    ],
    "outbounds": [
        {
            "type": "direct"
        }
    ]
}
EOF
echo "âœ… è‡ªå®šä¹‰é…ç½®å·²å†™å…¥ $SING_BOX_CONFIG/config.json"

# å¤‡ä»½åŽŸæœ‰ systemd æœåŠ¡æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
if [ -f "$SING_BOX_SERVICE" ]; then
    cp "$SING_BOX_SERVICE" "$SING_BOX_SERVICE.bak"
    echo "âœ… å¤‡ä»½åŽŸæœ‰ systemd æœåŠ¡æ–‡ä»¶è‡³ sing-box.service.bak"
fi

# å†™å…¥è‡ªå®šä¹‰ systemd æœåŠ¡æ–‡ä»¶
cat > "$SING_BOX_SERVICE" <<EOF
[Unit]
Description=Sing-box Service
After=network.target nss-lookup.target

[Service]
User=root
ExecStart=/usr/local/bin/sing-box run -c /etc/sing-box/config.json
Restart=on-failure
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF
echo "âœ… è‡ªå®šä¹‰ systemd æœåŠ¡æ–‡ä»¶å·²å†™å…¥ $SING_BOX_SERVICE"

# é‡æ–°åŠ è½½ systemd é…ç½®å¹¶é‡å¯ Sing-box
systemctl daemon-reload
systemctl enable sing-box
systemctl restart sing-box

echo "ðŸŽ‰ Sing-box å®‰è£…å®Œæˆå¹¶å·²åº”ç”¨è‡ªå®šä¹‰é…ç½®ï¼"
echo "ðŸ“Œ é…ç½®æ–‡ä»¶è·¯å¾„: $SING_BOX_CONFIG/config.json"
